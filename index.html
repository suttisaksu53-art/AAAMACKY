<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏¥‡∏ô (Google Sheets Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .color-box { transition: all 0.3s ease; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        .marker-box {
            position: absolute;
            width: 30px; height: 30px;
            border: 2px solid #00ff00;
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 4px rgba(0,0,0,0.8);
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: none;
        }
        .cursor-crosshair { cursor: crosshair; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        .credit-text {
            background: linear-gradient(to right, #10b981, #3b82f6);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: bold; letter-spacing: 1px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-2 md:p-8 flex flex-col">

    <!-- Loading Spinner with Force Close -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <button onclick="showLoading(false)" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 font-bold p-2" title="Force Close">
            <i class="fas fa-times fa-2x"></i>
        </button>
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-emerald-600 mb-4"></div>
        <p id="loadingText" class="text-emerald-700 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        <p class="text-xs text-gray-400 mt-2">(‡∏´‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏î X ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)</p>
    </div>

    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden w-full flex-grow">
        
        <!-- Header -->
        <div class="bg-emerald-600 p-6 text-white relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="white" stroke-width="1"/>
                    </pattern>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                </svg>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center gap-6 relative z-10">
                <div class="flex-shrink-0">
                    <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-xl hover:scale-105 transition-transform duration-300">
                        <circle cx="50" cy="50" r="48" fill="white" fill-opacity="0.95"/>
                        <circle cx="50" cy="50" r="45" stroke="#10B981" stroke-width="2" stroke-dasharray="8 4" stroke-opacity="0.5"/>
                        <path d="M20 75C20 75 35 65 50 65C65 65 80 75 80 75V85C80 85 65 90 50 90C35 90 20 85 20 85V75Z" fill="#8B4513"/>
                        <path d="M50 65V40" stroke="#A0522D" stroke-width="4" stroke-linecap="round"/>
                        <path d="M50 50C50 50 30 45 30 30C30 30 40 30 50 50Z" fill="#4ADE80"/>
                        <path d="M50 50C50 50 30 45 30 30C30 30 40 30 50 50Z" stroke="#16A34A" stroke-width="1"/>
                        <path d="M50 45C50 45 75 35 75 20C75 20 60 25 50 45Z" fill="#22C55E"/>
                        <path d="M50 45C50 45 75 35 75 20C75 20 60 25 50 45Z" stroke="#15803D" stroke-width="1"/>
                        <path d="M50 40C50 40 50 15 35 25C35 25 45 30 50 40Z" fill="#86EFAC"/>
                        <circle cx="30" cy="30" r="2" fill="#FBBF24"/>
                        <circle cx="70" cy="25" r="2" fill="#FBBF24"/>
                        <circle cx="50" cy="15" r="2" fill="#FBBF24"/>
                    </svg>
                </div>
                <div class="text-center md:text-left">
                    <h1 class="text-3xl md:text-4xl font-bold tracking-wide text-white drop-shadow-md">
                        Soil Color Chart Analyzer Pro
                    </h1>
                    <p class="mt-2 text-emerald-100 font-light text-lg">
                        <i class="fas fa-flask mr-2"></i>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏¥‡∏ô
                    </p>
                    <div id="dbStatus" class="text-xs text-yellow-200 mt-1 cursor-pointer hover:underline" onclick="switchTab('config')">
                        <i class="fas fa-database"></i> ‡πÇ‡∏´‡∏°‡∏î: Offline (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud)
                    </div>
                </div>
            </div>
            
            <div id="userInfoDisplay" class="absolute top-4 right-4 text-sm hidden z-20">
                <span id="loggedInUser" class="font-bold mr-2 bg-emerald-700 px-3 py-1 rounded-full bg-opacity-50"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-xs transition shadow-md font-bold">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="p-4 md:p-6">
            <div class="flex border-b mb-6">
                <button onclick="switchTab('analyze')" id="btn-analyze" class="flex-1 py-3 text-emerald-600 border-b-2 border-emerald-600 font-bold focus:outline-none transition">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•</button>
                <button onclick="switchTab('config')" id="btn-config" class="flex-1 py-3 text-gray-500 hover:text-emerald-500 font-medium focus:outline-none transition">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Admin)</button>
            </div>

            <!-- ANALYZE TAB -->
            <div id="tab-analyze" class="block animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="bg-white border rounded-lg p-4 shadow-sm">
                            <label class="font-bold text-gray-700 mb-2 block">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à:</label>
                            <select id="testType" class="w-full border rounded p-2 bg-gray-50 text-gray-700 font-semibold" onchange="analyzeSoil()">
                                <option value="N">Nitrogen (N) - ‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô</option>
                                <option value="Nitrate">Nitrate (NO3) - ‡πÑ‡∏ô‡πÄ‡∏ï‡∏£‡∏ó</option>
                                <option value="P">Phosphorus (P) - ‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™</option>
                                <option value="K">Potassium (K) - ‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°</option>
                                <option value="Soil Respiration">Soil Respiration - ‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏î‡∏¥‡∏ô</option>
                                <option value="pH">pH - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏î‡∏î‡πà‡∏≤‡∏á</option>
                            </select>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <label class="font-bold text-gray-700 mb-2 block">2. ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏µ (Source):</label>
                            <div class="flex gap-2 mb-4">
                                <button onclick="toggleCamera()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded shadow text-sm">
                                    <i class="fas fa-camera mr-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏Å‡∏•‡πâ‡∏≠‡∏á
                                </button>
                                <button onclick="triggerFileUpload()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded shadow text-sm">
                                    <i class="fas fa-image mr-1"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
                                </button>
                                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                            </div>
                            <div id="mediaContainer" class="relative w-full h-64 bg-black rounded-lg overflow-hidden hidden cursor-crosshair group" onclick="handleMediaClick(event)">
                                <button onclick="switchCamera(event)" id="btnFlipCamera" class="absolute top-2 right-2 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg z-30 transition transform active:scale-95 hidden">
                                    <i class="fas fa-sync-alt fa-lg text-emerald-600"></i>
                                </button>
                                <video id="videoElement" autoplay playsinline class="absolute top-0 left-0 w-full h-full object-contain hidden opacity-0"></video>
                                <img id="imagePreview" class="absolute top-0 left-0 w-full h-full object-contain hidden opacity-0" />
                                <canvas id="canvasElement" class="absolute top-0 left-0 w-full h-full"></canvas>
                                <div id="colorMarker" class="marker-box"></div>
                                <div class="absolute bottom-2 left-0 w-full text-center pointer-events-none z-20">
                                    <span class="bg-black/60 text-white px-3 py-1 rounded text-xs shadow">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Ñ‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î (30x30 px)</span>
                                </div>
                            </div>
                        </div>

                        <button id="btnManualAnalyze" onclick="analyzeSoil()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition transform active:scale-95 hidden">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                        <p class="text-center text-xs text-gray-400 mt-2" id="autoAnalyzeStatus"></p>
                    </div>

                    <div class="flex flex-col h-full space-y-6">
                        <div class="flex-grow flex flex-col justify-center items-center bg-emerald-50 rounded-xl border-2 border-emerald-100 p-6 text-center shadow-sm">
                            <h3 class="text-gray-500 font-medium uppercase tracking-wider mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
                            <div id="resultText" class="text-4xl md:text-6xl font-extrabold text-gray-300 animate-pulse">...</div>
                            <div id="resultDesc" class="mt-6 text-lg text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
                        </div>

                        <div class="bg-gray-100 p-6 rounded-lg relative shadow-inner">
                            <h2 class="text-sm font-bold text-gray-500 mb-4 uppercase">3. ‡∏Ñ‡πà‡∏≤‡∏™‡∏µ RGB (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</h2>
                            <div class="space-y-4">
                                <div><div class="flex justify-between"><label class="text-red-600 font-bold">R</label><span id="valR" class="text-gray-600">128</span></div><input type="range" id="inputR" min="0" max="255" value="128" class="w-full accent-red-500" oninput="updateInputDisplay()"></div>
                                <div><div class="flex justify-between"><label class="text-green-600 font-bold">G</label><span id="valG" class="text-gray-600">128</span></div><input type="range" id="inputG" min="0" max="255" value="128" class="w-full accent-green-500" oninput="updateInputDisplay()"></div>
                                <div><div class="flex justify-between"><label class="text-blue-600 font-bold">B</label><span id="valB" class="text-gray-600">128</span></div><input type="range" id="inputB" min="0" max="255" value="128" class="w-full accent-blue-500" oninput="updateInputDisplay()"></div>
                            </div>
                            <div id="brightnessContainer" class="mt-4 p-2 bg-yellow-100 rounded border border-yellow-300 hidden">
                                <div class="flex justify-between items-center text-yellow-800">
                                    <span class="font-bold text-sm"><i class="fas fa-sun mr-1"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á (Brightness)</span>
                                    <span id="valBrightness" class="font-mono font-bold">0</span>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center gap-4">
                                <div class="text-xs text-gray-500">‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</div>
                                <div id="colorPreview" class="w-full h-12 rounded shadow-inner border border-gray-300 bg-gray-400"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN TAB -->
            <div id="tab-config" class="hidden">
                <div id="login-panel" class="max-w-sm mx-auto mt-10 p-6 bg-white border rounded-xl shadow-md">
                    <div class="text-center mb-6">
                        <div class="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2 text-emerald-600"><i class="fas fa-user-lock text-2xl"></i></div>
                        <h2 class="text-xl font-bold text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    </div>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Username</label><input type="text" id="username" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-emerald-500" placeholder="Username" required></div>
                        <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">Password</label><input type="password" id="password" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-emerald-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-2 rounded hover:bg-emerald-700 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <p id="loginError" class="text-red-500 text-xs mt-3 text-center hidden">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                    </form>
                </div>

                <div id="admin-panel" class="hidden">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/4">
                            <div class="bg-gray-100 rounded-lg p-2 space-y-1">
                                <button onclick="switchAdminTab('color-config')" id="menu-color-config" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-emerald-700 bg-white shadow"><i class="fas fa-palette w-6"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ</button>
                                <button onclick="switchAdminTab('user-manage')" id="menu-user-manage" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600"><i class="fas fa-users-cog w-6"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                                <button onclick="switchAdminTab('change-pass')" id="menu-change-pass" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600"><i class="fas fa-key w-6"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
                                <button onclick="switchAdminTab('system-setup')" id="menu-system-setup" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600"><i class="fas fa-database w-6"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud</button>
                            </div>
                        </div>
                        <div class="w-full md:w-3/4 bg-white border rounded-lg p-6">
                            <!-- Cloud Setup -->
                            <div id="admin-system-setup" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</h3>
                                <div class="bg-blue-50 p-4 rounded text-sm text-blue-800 mb-4">
                                    <p><strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> <br>1. ‡∏ô‡∏≥ URL ‡∏Ç‡∏≠‡∏á Web App ‡∏°‡∏≤‡πÉ‡∏™‡πà <br>2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å <br>3. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Web App URL</label>
                                    <input type="text" id="sheetUrlInput" class="w-full px-3 py-2 border rounded text-sm" placeholder="https://script.google.com/macros/s/..../exec">
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="saveSheetUrl()" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL</button>
                                    <button onclick="forceSyncData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"><i class="fas fa-sync"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                </div>
                                <button onclick="clearSheetUrl()" class="text-red-500 mt-4 underline text-xs block">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                            </div>

                            <!-- Color Config -->
                            <div id="admin-color-config" class="block">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏µ (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</h3>
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r space-y-3">
                                    <h4 class="font-bold text-gray-800 border-b border-yellow-200 pb-1">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
                                    <div class="flex items-center"><input type="checkbox" id="toggleBrightness" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500" onchange="toggleBrightnessSetting()"><label for="toggleBrightness" class="ml-2 text-gray-700 font-medium cursor-pointer">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</label></div>
                                    <div class="flex items-center"><input type="checkbox" id="toggleRealTime" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500" onchange="toggleRealTimeSetting()"><label for="toggleRealTime" class="ml-2 text-gray-700 font-medium cursor-pointer">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• Real-time</label></div>
                                    <div class="mt-3 border-t border-yellow-200 pt-3">
                                        <label class="block text-gray-700 font-medium mb-1 text-sm"><i class="fas fa-video mr-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</label>
                                        <div class="flex gap-2"><select id="cameraSelect" class="flex-1 p-2 border rounded text-sm bg-white" onchange="updateCameraSelection()"><option value="">-- ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ --</option></select><button onclick="populateCameraList()" class="bg-yellow-500 text-white px-3 py-1 rounded text-xs hover:bg-yellow-600" title="Refresh"><i class="fas fa-sync"></i></button></div>
                                    </div>
                                </div>
                                <h4 class="font-bold text-gray-700 mb-2">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ</h4>
                                <div class="overflow-x-auto mb-6 max-h-96 overflow-y-auto border rounded"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-3 py-3">Type</th><th class="px-3 py-3">Level</th><th class="px-3 py-3 text-center">R</th><th class="px-3 py-3 text-center">G</th><th class="px-3 py-3 text-center">B</th><th class="px-3 py-3 text-center">Action</th></tr></thead><tbody id="configTableBody"></tbody></table></div>
                                <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="font-bold text-sm mb-2 text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2"><input id="newType" type="text" placeholder="Type" class="p-2 border rounded text-sm"><input id="newLevel" type="text" placeholder="Level" class="p-2 border rounded text-sm"><input id="newRMin" type="number" placeholder="R Min" class="p-2 border rounded text-sm"><input id="newRMax" type="number" placeholder="R Max" class="p-2 border rounded text-sm"><input id="newGMin" type="number" placeholder="G Min" class="p-2 border rounded text-sm"><input id="newGMax" type="number" placeholder="G Max" class="p-2 border rounded text-sm"><input id="newBMin" type="number" placeholder="B Min" class="p-2 border rounded text-sm"><input id="newBMax" type="number" placeholder="B Max" class="p-2 border rounded text-sm"></div><button onclick="addRange()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm w-full"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
                            </div>

                            <div id="admin-user-manage" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin Only)</h3>
                                <div class="mb-6"><table class="w-full text-sm text-left text-gray-500 border rounded"><thead class="bg-gray-100 text-gray-700"><tr><th class="px-4 py-2">Username</th><th class="px-4 py-2">Role</th><th class="px-4 py-2 text-right">Action</th></tr></thead><tbody id="userTableBody"></tbody></table></div>
                                <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="font-bold text-sm mb-2 text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h4><div class="flex gap-2"><input id="newUsername" type="text" placeholder="Username" class="flex-1 p-2 border rounded text-sm"><input id="newPassword" type="text" placeholder="Password" class="flex-1 p-2 border rounded text-sm"><button onclick="addUser()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á</button></div></div>
                            </div>

                            <div id="admin-change-pass" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                                <div class="max-w-md"><div class="mb-4"><label class="block text-gray-700 text-sm mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="password" id="changeNewPass" class="w-full p-2 border rounded"></div><div class="mb-4"><label class="block text-gray-700 text-sm mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="password" id="changeConfirmPass" class="w-full p-2 border rounded"></div><button onclick="changePassword()" class="bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-4"><p class="text-xs font-mono credit-text opacity-70 hover:opacity-100 transition duration-300">‚ú® Design by AAAmacky</p></div>

<script>
    // --- STORAGE ENGINE ---
    const StorageEngine = {
        sheetUrl: localStorage.getItem('soil_sheet_url') || '',
        async get(key) {
            if (this.sheetUrl) {
                try {
                    const response = await fetch(`${this.sheetUrl}?action=read&key=${key}&t=${new Date().getTime()}`);
                    const result = await response.json();
                    if(result.status === 'success') {
                        return result.data ? JSON.stringify(result.data) : null;
                    }
                } catch(e) { console.error("Cloud Read Error", e); }
            } 
            return localStorage.getItem(key);
        },
        async set(key, value) {
            localStorage.setItem(key, value);
            if (this.sheetUrl) {
                try {
                    await fetch(this.sheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'write', key: key, value: value })
                    });
                } catch(e) { console.error("Cloud Write Error", e); }
            }
        }
    };

    // --- GLOBAL STATE ---
    let users = [];
    let currentUser = null;
    let mySoilData = []; 
    let myPreferences = { showBrightness: false, useRealTimeAnalysis: true, selectedCameraId: '' };
    
    // --- DEFAULTS ---
    const DEFAULT_USERS = [
        { id: 1, username: 'admin', password: 'admin123', role: 'admin' }, 
        { id: 2, username: 'staff', password: '123', role: 'user' }
    ];
    const DEFAULT_SOIL_DATA = [
        { type: 'N', level: '‡∏ï‡πà‡∏≥ (Low)', r: [200, 255], g: [180, 230], b: [180, 230] }, 
        { type: 'N', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)', r: [200, 255], g: [100, 179], b: [100, 179] },
        { type: 'N', level: '‡∏™‡∏π‡∏á (High)', r: [150, 255], g: [0, 99], b: [0, 99] },
        { type: 'Nitrate', level: '‡∏ï‡πà‡∏≥ (0-10)', r: [240, 255], g: [240, 255], b: [240, 255] },
        { type: 'Nitrate', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (10-25)', r: [230, 250], g: [200, 220], b: [230, 250] },
        { type: 'Nitrate', level: '‡∏™‡∏π‡∏á (>25)', r: [200, 230], g: [150, 180], b: [200, 230] },
        { type: 'P', level: '‡∏ï‡πà‡∏≥ (Low)', r: [180, 220], g: [180, 220], b: [220, 255] },
        { type: 'P', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)', r: [100, 179], g: [100, 179], b: [100, 179] },
        { type: 'P', level: '‡∏™‡∏π‡∏á (High)', r: [0, 99], g: [0, 99], b: [150, 255] },
        { type: 'K', level: '‡∏ï‡πà‡∏≥ (Low)', r: [240, 255], g: [240, 255], b: [200, 240] },
        { type: 'K', level: '‡∏™‡∏π‡∏á (High)', r: [200, 230], g: [200, 230], b: [100, 180] },
        { type: 'Soil Respiration', level: '‡∏ï‡πà‡∏≥ (Low)', r: [200, 220], g: [200, 220], b: [200, 220] }, 
        { type: 'Soil Respiration', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)', r: [150, 180], g: [150, 180], b: [150, 180] },
        { type: 'Soil Respiration', level: '‡∏™‡∏π‡∏á (High)', r: [100, 130], g: [100, 130], b: [100, 130] },
        { type: 'pH', level: '4.5 (‡∏Å‡∏£‡∏î‡∏à‡∏±‡∏î)', r: [255, 255], g: [150, 180], b: [150, 180] }, 
        { type: 'pH', level: '7.0 (‡∏Å‡∏•‡∏≤‡∏á)', r: [100, 150], g: [200, 250], b: [100, 150] } 
    ];

    // --- SYSTEM INIT ---
    async function initSystem() {
        checkDbStatus();
        await loadUsersList();
    }

    function checkDbStatus() {
        const statusDiv = document.getElementById('dbStatus');
        if (StorageEngine.sheetUrl) {
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> ‡πÇ‡∏´‡∏°‡∏î: Online (Google Sheets)';
            statusDiv.className = "text-xs text-emerald-100 mt-1 cursor-pointer hover:underline";
        } else {
            statusDiv.innerHTML = '<i class="fas fa-database"></i> ‡πÇ‡∏´‡∏°‡∏î: Offline (Device Storage)';
            statusDiv.className = "text-xs text-yellow-200 mt-1 cursor-pointer hover:underline";
        }
    }

    async function saveSheetUrl() {
        const url = document.getElementById('sheetUrlInput').value.trim();
        if(!url) return;
        localStorage.setItem('soil_sheet_url', url);
        StorageEngine.sheetUrl = url;
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        checkDbStatus();
        if(currentUser && currentUser.role === 'admin') {
            await StorageEngine.set('soil_sys_users', JSON.stringify(users));
        }
    }

    // New Function to force sync/test
    async function forceSyncData() {
        if(!currentUser) return;
        alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets...");
        await saveUserData();
        if(currentUser.role === 'admin') await StorageEngine.set('soil_sys_users', JSON.stringify(users));
        alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Google Sheets");
    }

    function clearSheetUrl() {
        if(confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud?")) {
            localStorage.removeItem('soil_sheet_url');
            StorageEngine.sheetUrl = '';
            checkDbStatus();
            alert("‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î Offline");
        }
    }

    async function loadUsersList() {
        const storedUsers = await StorageEngine.get('soil_sys_users');
        if (storedUsers) {
            users = JSON.parse(storedUsers);
        } else {
            users = JSON.parse(JSON.stringify(DEFAULT_USERS));
            if (!StorageEngine.sheetUrl) localStorage.setItem('soil_sys_users', JSON.stringify(users));
        }
    }

    async function loadUserData(username) {
        showLoading(true);
        try {
            const storedData = await StorageEngine.get(`soil_settings_${username}`);
            if (storedData) {
                const parsed = JSON.parse(storedData);
                mySoilData = parsed.soilData || [];
                myPreferences = parsed.preferences || myPreferences;
            } else {
                mySoilData = JSON.parse(JSON.stringify(DEFAULT_SOIL_DATA));
                saveUserData();
            }
        } catch (e) {
            console.error(e);
        } finally {
            showLoading(false); // ALWAYS Hide
        }
    }

    async function saveUserData() {
        if (!currentUser) return;
        const payload = { soilData: mySoilData, preferences: myPreferences };
        await StorageEngine.set(`soil_settings_${currentUser.username}`, JSON.stringify(payload));
    }

    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if(show) overlay.classList.remove('hidden');
        else overlay.classList.add('hidden');
    }

    // --- AUTH ---
    async function handleLogin(e) {
        e.preventDefault();
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        
        showLoading(true);
        await loadUsersList();
        showLoading(false);

        const foundUser = users.find(user => user.username === u && user.password === p);
        if (foundUser) performLogin(foundUser);
        else document.getElementById('loginError').classList.remove('hidden');
    }

    async function performLogin(user) {
        currentUser = user;
        await loadUserData(user.username);

        document.getElementById('login-panel').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        document.getElementById('userInfoDisplay').classList.remove('hidden');
        document.getElementById('loggedInUser').innerText = `üë§ ${user.username}`;
        
        const userManageBtn = document.getElementById('menu-user-manage');
        if (user.role === 'admin') userManageBtn.classList.remove('hidden');
        else userManageBtn.classList.add('hidden');

        document.getElementById('toggleBrightness').checked = myPreferences.showBrightness;
        document.getElementById('toggleRealTime').checked = myPreferences.useRealTimeAnalysis;
        document.getElementById('sheetUrlInput').value = StorageEngine.sheetUrl;
        
        toggleBrightnessSetting(false);
        toggleRealTimeSetting(false);
        populateCameraList();
        renderConfigTable();
        renderUserTable();
        
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').classList.add('hidden');
    }

    function logout() {
        if(isCameraActive) {
            stopCameraStream();
            document.getElementById('mediaContainer').classList.add('hidden');
        }
        currentUser = null;
        mySoilData = [];
        document.getElementById('userInfoDisplay').classList.add('hidden');
        if(!document.getElementById('tab-config').classList.contains('hidden')) {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-panel').classList.remove('hidden');
        }
    }

    // --- ADMIN & LOGIC ---
    function switchAdminTab(subTab) {
        if (subTab === 'user-manage' && (!currentUser || currentUser.role !== 'admin')) {
            alert("‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò");
            return;
        }
        const tabs = ['admin-color-config', 'admin-user-manage', 'admin-change-pass', 'admin-system-setup'];
        const btns = ['menu-color-config', 'menu-user-manage', 'menu-change-pass', 'menu-system-setup'];
        
        tabs.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });
        btns.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.className = "w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600";
        });
        
        const targetTab = document.getElementById('admin-' + subTab);
        if(targetTab) targetTab.classList.remove('hidden');
        
        const targetBtn = document.getElementById('menu-' + subTab);
        if(targetBtn) targetBtn.className = "w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-emerald-700 bg-white shadow";
    }

    function toggleBrightnessSetting(save=true) {
        const val = document.getElementById('toggleBrightness').checked;
        const div = document.getElementById('brightnessContainer');
        if(val) div.classList.remove('hidden'); else div.classList.add('hidden');
        if(save && currentUser) { myPreferences.showBrightness = val; saveUserData(); }
    }

    function updateInterfaceState() {
        const btn = document.getElementById('btnManualAnalyze');
        const statusTxt = document.getElementById('autoAnalyzeStatus');
        
        if (myPreferences.useRealTimeAnalysis) {
            btn.classList.add('hidden'); 
            statusTxt.innerText = "(Auto Analysis: ON)";
            analyzeSoil(); 
        } else {
            btn.classList.remove('hidden'); 
            statusTxt.innerText = "";
        }
        
        // Sync checkbox if it exists and we're not inside toggleRealTimeSetting(true) loop essentially,
        // but this helper sets UI based on PREFERENCE state.
        const checkbox = document.getElementById('toggleRealTime');
        if(checkbox) checkbox.checked = myPreferences.useRealTimeAnalysis;
    }

    function toggleRealTimeSetting(save=true) {
        const isChecked = document.getElementById('toggleRealTime').checked;
        
        if(save && currentUser) {
            myPreferences.useRealTimeAnalysis = isChecked;
            saveUserData();
        } else {
             myPreferences.useRealTimeAnalysis = isChecked;
        }
        updateInterfaceState();
    }

    function renderConfigTable() {
        const tbody = document.getElementById('configTableBody');
        tbody.innerHTML = '';
        mySoilData.forEach((d, i) => {
            tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-3 py-2 font-bold">${d.type}</td><td class="px-3 py-2 text-xs">${d.level}</td><td class="px-3 py-2 text-red-600 text-xs">${d.r[0]}-${d.r[1]}</td><td class="px-3 py-2 text-green-600 text-xs">${d.g[0]}-${d.g[1]}</td><td class="px-3 py-2 text-blue-600 text-xs">${d.b[0]}-${d.b[1]}</td><td class="px-3 py-2"><button onclick="removeRange(${i})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }

    function addRange() {
        const inputs = ['newType', 'newLevel', 'newRMin', 'newRMax', 'newGMin', 'newGMax', 'newBMin', 'newBMax'];
        const vals = inputs.map(id => document.getElementById(id).value);
        if(vals.some(v => v === '')) { alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö"); return; }
        mySoilData.push({
            type: vals[0], level: vals[1],
            r: [parseInt(vals[2]), parseInt(vals[3])],
            g: [parseInt(vals[4]), parseInt(vals[5])],
            b: [parseInt(vals[6]), parseInt(vals[7])]
        });
        saveUserData();
        renderConfigTable();
        alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    function removeRange(i) {
        if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
            mySoilData.splice(i, 1);
            saveUserData();
            renderConfigTable();
        }
    }

    function renderUserTable() {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';
        users.forEach((u, i) => {
            tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-2 font-medium">${u.username}</td><td class="px-4 py-2 text-xs">${u.role}</td><td class="px-4 py-2 text-right">${u.username !== 'admin' ? `<button onclick="deleteUser(${i})" class="text-red-500"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`;
        });
    }

    function addUser() {
        const u = document.getElementById('newUsername').value;
        const p = document.getElementById('newPassword').value;
        if(u && p) {
            if(users.some(x => x.username === u)) { alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥"); return; }
            users.push({ id: Date.now(), username: u, password: p, role: 'user' });
            StorageEngine.set('soil_sys_users', JSON.stringify(users));
            renderUserTable();
            alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    }

    function deleteUser(i) {
        if(confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?")) {
            users.splice(i, 1);
            StorageEngine.set('soil_sys_users', JSON.stringify(users));
            renderUserTable();
        }
    }

    function changePassword() {
        const p1 = document.getElementById('changeNewPass').value;
        const p2 = document.getElementById('changeConfirmPass').value;
        if(p1 !== p2 || p1.length < 3) { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
        const idx = users.findIndex(u => u.username === currentUser.username);
        if(idx !== -1) {
            users[idx].password = p1;
            StorageEngine.set('soil_sys_users', JSON.stringify(users));
            alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    }

    // --- CAMERA & ANALYZE ---
    let isCameraActive = false;
    let markerPosition = null; 
    let currentFacingMode = 'environment';

    function toggleCamera() {
        const container = document.getElementById('mediaContainer');
        const video = document.getElementById('videoElement');
        const img = document.getElementById('imagePreview');
        const btnFlip = document.getElementById('btnFlipCamera');

        if (isCameraActive) {
            stopCameraStream();
            container.classList.add('hidden');
            btnFlip.classList.add('hidden');
        } else {
            container.classList.remove('hidden');
            img.classList.add('hidden');
            btnFlip.classList.remove('hidden');
            let constraints = { video: { facingMode: currentFacingMode } };
            if (myPreferences.selectedCameraId) constraints.video = { deviceId: { exact: myPreferences.selectedCameraId } };
            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                isCameraActive = true;
                video.onloadedmetadata = () => drawVideoToCanvasLoop();
            }).catch(e => alert("Camera Error: " + e));
        }
    }

    function switchCamera(e) {
        if(e) e.stopPropagation();
        if(!isCameraActive) return;
        currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
        stopCameraStream();
        navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } }).then(stream => {
            videoStream = stream;
            document.getElementById('videoElement').srcObject = stream;
            isCameraActive = true;
            drawVideoToCanvasLoop();
        });
    }

    function stopCameraStream() {
        if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        isCameraActive = false;
    }

    function drawVideoToCanvasLoop() {
        if(!isCameraActive) return;
        const vid = document.getElementById('videoElement');
        const cvs = document.getElementById('canvasElement');
        const ctx = cvs.getContext('2d');
        if(vid.readyState === vid.HAVE_ENOUGH_DATA) {
            if(cvs.width !== vid.videoWidth) { cvs.width = vid.videoWidth; cvs.height = vid.videoHeight; }
            ctx.drawImage(vid, 0, 0);
            if(markerPosition) processAreaColor(cvs, markerPosition.x, markerPosition.y);
        }
        requestAnimationFrame(drawVideoToCanvasLoop);
    }

    function triggerFileUpload() { document.getElementById('fileInput').click(); }
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Stop camera if active to switch to image mode
        if (isCameraActive) toggleCamera(); 

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('imagePreview');
            img.src = e.target.result;
            
            // Show media container
            document.getElementById('mediaContainer').classList.remove('hidden');
            document.getElementById('btnFlipCamera').classList.add('hidden'); // Hide flip button for static images
            img.classList.remove('hidden');
            document.getElementById('colorMarker').style.display = 'none';
            markerPosition = null;

            img.onload = function() {
                const canvas = document.getElementById('canvasElement');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                canvas.getContext('2d').drawImage(img, 0, 0);
            }
        };
        reader.readAsDataURL(file);
    }

    function handleMediaClick(e) {
        if(e.target.closest('button')) return;
        const rect = e.currentTarget.getBoundingClientRect();
        markerPosition = { x: e.clientX, y: e.clientY };
        const marker = document.getElementById('colorMarker');
        marker.style.display = 'block';
        marker.style.left = (e.clientX - rect.left) + 'px';
        marker.style.top = (e.clientY - rect.top) + 'px';
        if(!isCameraActive) processAreaColor(document.getElementById('canvasElement'), e.clientX, e.clientY);
    }

    function processAreaColor(cvs, cx, cy) {
        const rect = cvs.getBoundingClientRect();
        const scaleX = cvs.width / rect.width;
        const scaleY = cvs.height / rect.height;
        const sx = Math.floor(((cx - rect.left) * scaleX) - 15);
        const sy = Math.floor(((cy - rect.top) * scaleY) - 15);
        try {
            const data = cvs.getContext('2d').getImageData(sx, sy, 30, 30).data;
            let r=0, g=0, b=0, c=0;
            for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; c++; }
            if(c>0) {
                document.getElementById('inputR').value = Math.round(r/c);
                document.getElementById('inputG').value = Math.round(g/c);
                document.getElementById('inputB').value = Math.round(b/c);
                document.getElementById('valBrightness').innerText = Math.round(((r/c)*299 + (g/c)*587 + (b/c)*114)/1000);
                updateInputDisplay();
            }
        } catch(e){}
    }

    function updateInputDisplay() {
        const r = document.getElementById('inputR').value;
        const g = document.getElementById('inputG').value;
        const b = document.getElementById('inputB').value;
        document.getElementById('valR').innerText = r;
        document.getElementById('valG').innerText = g;
        document.getElementById('valB').innerText = b;
        document.getElementById('colorPreview').style.backgroundColor = `rgb(${r},${g},${b})`;
        if(myPreferences.useRealTimeAnalysis) analyzeSoil();
    }

    function analyzeSoil() {
        const r = parseInt(document.getElementById('inputR').value);
        const g = parseInt(document.getElementById('inputG').value);
        const b = parseInt(document.getElementById('inputB').value);
        const type = document.getElementById('testType').value;
        const candidates = mySoilData.filter(d => d.type === type);
        let match = null, closest = null, minD = Infinity;
        for(let item of candidates) {
            if(r >= item.r[0] && r <= item.r[1] && g >= item.g[0] && g <= item.g[1] && b >= item.b[0] && b <= item.b[1]) { match = item; break; }
            const cR = (item.r[0]+item.r[1])/2, cG = (item.g[0]+item.g[1])/2, cB = (item.b[0]+item.b[1])/2;
            const dist = Math.sqrt(Math.pow(r-cR,2)+Math.pow(g-cG,2)+Math.pow(b-cB,2));
            if(dist < minD) { minD = dist; closest = item; }
        }
        const txt = document.getElementById('resultText');
        const desc = document.getElementById('resultDesc');
        if(match) {
            txt.innerText = match.level; txt.className = "text-4xl md:text-6xl font-extrabold text-emerald-600"; desc.innerText = "‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
        } else if (closest && minD < 80) {
            txt.innerText = closest.level + "*"; txt.className = "text-4xl md:text-6xl font-extrabold text-yellow-600"; desc.innerText = "‡∏Ñ‡πà‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)";
        } else {
            txt.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; txt.className = "text-4xl md:text-6xl font-extrabold text-gray-400"; desc.innerText = "‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }
    }

    function populateCameraList() {
        const select = document.getElementById('cameraSelect');
        select.innerHTML = '<option value="">-- ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ --</option>';
        navigator.mediaDevices.enumerateDevices().then(devices => {
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${index + 1}`; 
                if(device.deviceId === myPreferences.selectedCameraId) option.selected = true;
                select.appendChild(option);
            });
        });
    }
    
    function updateCameraSelection() {
        if(currentUser) {
            myPreferences.selectedCameraId = document.getElementById('cameraSelect').value;
            saveUserData();
        }
    }

    function switchTab(t) {
        if(t === 'config' && !currentUser) {
            document.getElementById('tab-analyze').classList.add('hidden');
            document.getElementById('tab-config').classList.remove('hidden');
            document.getElementById('login-panel').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        } else if (t === 'config') {
            document.getElementById('tab-analyze').classList.add('hidden');
            document.getElementById('tab-config').classList.remove('hidden');
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        } else {
            document.getElementById('tab-analyze').classList.remove('hidden');
            document.getElementById('tab-config').classList.add('hidden');
        }
    }

    // Init
    initSystem();
    updateInterfaceState();
    updateInputDisplay();

</script>
</body>
</html>
